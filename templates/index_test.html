<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerKeyOSS - 功能测试工具</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        .card-header {
            background-color: #343a40;
            color: white;
            font-weight: 600;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #545b62;
            border-color: #494f54;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .tab-content {
            padding: 20px;
            background-color: white;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .nav-tabs .nav-link {
            border-radius: 0;
            color: #495057;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .nav-tabs .nav-link.active {
            color: #007bff;
            border-color: #dee2e6 #dee2e6 white;
            border-bottom: 3px solid #007bff;
        }
        .alert {
            border-radius: 8px;
            margin-top: 15px;
        }
        .list-group-item {
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        .list-group-item:hover {
            background-color: #f8f9fa;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .spinner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            display: none;
        }
        .spinner-border {
            width: 4rem;
            height: 4rem;
        }
        .badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
    </style>
</head>
<body>
    <!-- 加载中指示器 -->
    <div id="loading-indicator" class="spinner-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">处理中...</span>
        </div>
    </div>

    <div class="container mt-5">
        <div class="mb-5 text-center">
            <h1 class="display-4 text-primary">VerKeyOSS <span class="text-secondary">功能测试工具</span></h1>
            <p class="text-muted">一站式测试所有API功能</p>
        </div>

        <!-- 连接配置 -->
        <div class="card mb-5">
            <div class="card-header">
                <h2 class="h4 mb-0"><i class="fa fa-cog mr-2"></i>连接配置</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="api-url" class="form-label">API 基础地址</label>
                            <input type="text" id="api-url" class="form-control" value="http://localhost:8913/api" placeholder="输入API基础地址">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">连接状态</label>
                            <div class="d-flex align-items-center">
                                <span id="connection-status" class="badge bg-secondary">未连接</span>
                                <button id="test-connection" class="btn btn-primary btn-sm ms-2">测试连接</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 标签页导航 -->
        <ul class="nav nav-tabs mb-0" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-panel" type="button" role="tab" aria-controls="login-panel" aria-selected="true">
                    <i class="fa fa-sign-in mr-2"></i>管理员登录
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="software-tab" data-bs-toggle="tab" data-bs-target="#software-panel" type="button" role="tab" aria-controls="software-panel" aria-selected="false" disabled>
                    <i class="fa fa-cube mr-2"></i>软件管理
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="version-tab" data-bs-toggle="tab" data-bs-target="#version-panel" type="button" role="tab" aria-controls="version-panel" aria-selected="false" disabled>
                    <i class="fa fa-code-fork mr-2"></i>版本管理
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="check-tab" data-bs-toggle="tab" data-bs-target="#check-panel" type="button" role="tab" aria-controls="check-panel" aria-selected="false">
                    <i class="fa fa-check-circle mr-2"></i>校验功能
                </button>
            </li>
        </ul>

        <!-- 标签页内容 -->
        <div class="tab-content" id="main-tab-content">
            <!-- 登录面板 -->
            <div class="tab-pane fade show active" id="login-panel" role="tabpanel" aria-labelledby="login-tab">
                <div class="row">
                    <div class="col-md-6">
                        <h3 class="h5 mb-4"><i class="fa fa-sign-in mr-2"></i>管理员登录</h3>
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="username" class="form-label">用户名</label>
                                <input type="text" id="username" class="form-control" value="verkey" placeholder="输入用户名">
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">密码</label>
                                <input type="password" id="password" class="form-control" value="verkey" placeholder="输入密码">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-sign-in mr-2"></i>登录
                            </button>
                        </form>
                        
                        <h3 class="h5 mt-6 mb-4"><i class="fa fa-key mr-2"></i>修改密码</h3>
                        <form id="change-password-form">
                            <div class="mb-3">
                                <label for="old-password" class="form-label">原密码</label>
                                <input type="password" id="old-password" class="form-control" placeholder="输入原密码">
                            </div>
                            <div class="mb-3">
                                <label for="new-password" class="form-label">新密码</label>
                                <input type="password" id="new-password" class="form-control" placeholder="输入新密码">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-save mr-2"></i>修改密码
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h3 class="h5 mb-4"><i class="fa fa-info-circle mr-2"></i>登录信息</h3>
                        <div id="login-info" class="mb-4">
                            <p class="text-muted">未登录</p>
                        </div>
                        <h3 class="h5 mb-4"><i class="fa fa-history mr-2"></i>请求历史</h3>
                        <div id="login-history" class="code-block" style="max-height: 300px; overflow-y: auto;">
                            <!-- 请求历史会显示在这里 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 软件管理面板 -->
            <div class="tab-pane fade" id="software-panel" role="tabpanel" aria-labelledby="software-tab">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h3 class="h5 mb-4"><i class="fa fa-plus-circle mr-2"></i>创建软件</h3>
                        <form id="create-software-form">
                            <div class="mb-3">
                                <label for="software-name" class="form-label">软件名称</label>
                                <input type="text" id="software-name" class="form-control" placeholder="输入软件名称">
                            </div>
                            <div class="mb-3">
                                <label for="software-description" class="form-label">软件描述</label>
                                <textarea id="software-description" class="form-control" rows="3" placeholder="输入软件描述"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-plus mr-2"></i>创建
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h3 class="h5 mb-4"><i class="fa fa-search mr-2"></i>获取软件信息</h3>
                        <div class="mb-3">
                            <label for="software-akey" class="form-label">软件AKey</label>
                            <input type="text" id="software-akey" class="form-control" placeholder="输入软件AKey">
                        </div>
                        <button id="get-software-btn" class="btn btn-secondary mb-4">
                            <i class="fa fa-search mr-2"></i>查询
                        </button>
                        <div id="software-info" class="code-block" style="max-height: 200px; overflow-y: auto;">
                            <!-- 软件信息会显示在这里 -->
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <h3 class="h5 mb-4"><i class="fa fa-list mr-2"></i>软件列表</h3>
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-2">
                                    <label for="software-page" class="form-label">页码</label>
                                    <input type="number" id="software-page" class="form-control" value="1" min="1">
                                </div>
                                <div class="col-md-2">
                                    <label for="software-size" class="form-label">每页数量</label>
                                    <input type="number" id="software-size" class="form-control" value="10" min="1" max="100">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="list-software-btn" class="btn btn-primary w-100">
                                        <i class="fa fa-refresh mr-2"></i>刷新列表
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="software-list" class="code-block" style="max-height: 400px; overflow-y: auto;">
                            <!-- 软件列表会显示在这里 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 版本管理面板 -->
            <div class="tab-pane fade" id="version-panel" role="tabpanel" aria-labelledby="version-tab">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h3 class="h5 mb-4"><i class="fa fa-plus-circle mr-2"></i>发布新版本</h3>
                        <form id="create-version-form">
                            <div class="mb-3">
                                <label for="version-akey" class="form-label">软件AKey</label>
                                <input type="text" id="version-akey" class="form-control" placeholder="输入软件AKey">
                            </div>
                            <div class="mb-3">
                                <label for="version-number" class="form-label">版本号</label>
                                <input type="text" id="version-number" class="form-control" placeholder="输入版本号（如1.0.0）">
                            </div>
                            <div class="mb-3">
                                <label for="version-description" class="form-label">版本描述</label>
                                <textarea id="version-description" class="form-control" rows="3" placeholder="输入版本描述"></textarea>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" id="version-is-latest" class="form-check-input">
                                <label for="version-is-latest" class="form-check-label">标记为最新版本</label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-plus mr-2"></i>发布
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h3 class="h5 mb-4"><i class="fa fa-search mr-2"></i>获取版本信息</h3>
                        <div class="mb-3">
                            <label for="version-vkey" class="form-label">版本VKey</label>
                            <input type="text" id="version-vkey" class="form-control" placeholder="输入版本VKey">
                        </div>
                        <button id="get-version-btn" class="btn btn-secondary mb-4">
                            <i class="fa fa-search mr-2"></i>查询
                        </button>
                        <div id="version-info" class="code-block" style="max-height: 200px; overflow-y: auto;">
                            <!-- 版本信息会显示在这里 -->
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <h3 class="h5 mb-4"><i class="fa fa-list mr-2"></i>版本列表</h3>
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="list-version-akey" class="form-label">软件AKey</label>
                                    <input type="text" id="list-version-akey" class="form-control" placeholder="输入软件AKey">
                                </div>
                                <div class="col-md-2">
                                    <label for="version-page" class="form-label">页码</label>
                                    <input type="number" id="version-page" class="form-control" value="1" min="1">
                                </div>
                                <div class="col-md-2">
                                    <label for="version-size" class="form-label">每页数量</label>
                                    <input type="number" id="version-size" class="form-control" value="10" min="1" max="100">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="list-version-btn" class="btn btn-primary w-100">
                                        <i class="fa fa-refresh mr-2"></i>刷新列表
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="version-list" class="code-block" style="max-height: 400px; overflow-y: auto;">
                            <!-- 版本列表会显示在这里 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 校验功能面板 -->
            <div class="tab-pane fade" id="check-panel" role="tabpanel" aria-labelledby="check-tab">
                <div class="row">
                    <div class="col-md-6">
                        <h3 class="h5 mb-4"><i class="fa fa-check-circle mr-2"></i>校验合法性</h3>
                        <form id="check-legality-form">
                            <div class="mb-3">
                                <label for="legality-akey" class="form-label">软件AKey</label>
                                <input type="text" id="legality-akey" class="form-control" placeholder="输入软件AKey">
                            </div>
                            <div class="mb-3">
                                <label for="legality-vkey" class="form-label">版本VKey</label>
                                <input type="text" id="legality-vkey" class="form-control" placeholder="输入版本VKey">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-check mr-2"></i>校验
                            </button>
                        </form>
                        <div id="legality-result" class="mt-4 code-block">
                            <!-- 校验结果会显示在这里 -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h3 class="h5 mb-4"><i class="fa fa-refresh mr-2"></i>检测更新</h3>
                        <form id="check-update-form">
                            <div class="mb-3">
                                <label for="update-akey" class="form-label">软件AKey</label>
                                <input type="text" id="update-akey" class="form-control" placeholder="输入软件AKey">
                            </div>
                            <div class="mb-3">
                                <label for="update-vkey" class="form-label">当前版本VKey</label>
                                <input type="text" id="update-vkey" class="form-control" placeholder="输入当前版本VKey">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-search mr-2"></i>检测
                            </button>
                        </form>
                        <div id="update-result" class="mt-4 code-block">
                            <!-- 更新检测结果会显示在这里 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入 Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let token = null;
        let apiBaseUrl = 'http://localhost:8913/api';
        let selectedSoftware = null;
        let selectedVersion = null;

        // DOM 加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化表单提交事件
            initFormSubmits();
            // 初始化按钮点击事件
            initButtonClicks();
            // 初始化API地址输入框
            initApiUrlInput();
        });

        // 初始化表单提交事件
        function initFormSubmits() {
            // 登录表单
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            // 修改密码表单
            document.getElementById('change-password-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleChangePassword();
            });

            // 创建软件表单
            document.getElementById('create-software-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleCreateSoftware();
            });

            // 创建版本表单
            document.getElementById('create-version-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleCreateVersion();
            });

            // 校验合法性表单
            document.getElementById('check-legality-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleCheckLegality();
            });

            // 检测更新表单
            document.getElementById('check-update-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleCheckUpdate();
            });
        }

        // 初始化按钮点击事件
        function initButtonClicks() {
            // 测试连接按钮
            document.getElementById('test-connection').addEventListener('click', function() {
                testConnection();
            });

            // 获取软件信息按钮
            document.getElementById('get-software-btn').addEventListener('click', function() {
                getSoftwareInfo();
            });

            // 刷新软件列表按钮
            document.getElementById('list-software-btn').addEventListener('click', function() {
                getSoftwareList();
            });

            // 获取版本信息按钮
            document.getElementById('get-version-btn').addEventListener('click', function() {
                getVersionInfo();
            });

            // 刷新版本列表按钮
            document.getElementById('list-version-btn').addEventListener('click', function() {
                getVersionList();
            });
        }

        // 初始化API地址输入框
        function initApiUrlInput() {
            const apiUrlInput = document.getElementById('api-url');
            apiBaseUrl = apiUrlInput.value;
            apiUrlInput.addEventListener('change', function() {
                apiBaseUrl = this.value;
                showAlert('API地址已更新为: ' + apiBaseUrl, 'info');
            });
        }

        // 显示加载指示器
        function showLoading() {
            const loadingElement = document.getElementById('loading-indicator');
            if (loadingElement) {
                try {
                    loadingElement.style.display = 'flex';
                } catch (error) {
                    console.log('显示加载指示器时出错:', error);
                }
            }
        }

        // 隐藏加载指示器
        function hideLoading() {
            const loadingElement = document.getElementById('loading-indicator');
            if (loadingElement) {
                try {
                    loadingElement.style.display = 'none';
                } catch (error) {
                    console.log('隐藏加载指示器时出错:', error);
                }
            }
        }

        // 显示提示信息
        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
            alertContainer.role = 'alert';
            alertContainer.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // 添加到页面顶部
            const container = document.querySelector('.container');
            container.insertBefore(alertContainer, container.firstChild);
            
            // 保存引用，用于检查元素是否仍然存在
            const alertElement = alertContainer;
            
            // 5秒后自动关闭
            setTimeout(() => {
                // 检查元素是否仍然存在于DOM中
                if (document.contains(alertElement)) {
                    // 淡出动画
                    alertElement.classList.remove('show');
                    
                    // 等待动画完成后再移除元素
                    setTimeout(() => {
                        // 再次检查元素是否仍然存在
                        if (document.contains(alertElement)) {
                            try {
                                alertElement.remove();
                            } catch (error) {
                                // 忽略移除失败的错误
                                console.log('移除提示框时出错:', error);
                            }
                        }
                    }, 300);
                }
            }, 5000);
        }

        // 添加请求历史
        function addRequestHistory(method, url, requestData, responseData) {
            const historyElement = document.getElementById('login-history');
            if (!historyElement) return; // 如果元素不存在，直接返回
            
            const timestamp = new Date().toLocaleTimeString();
            const historyItem = document.createElement('div');
            historyItem.className = 'mb-2 pb-2 border-b border-gray-200';
            historyItem.innerHTML = `
                <div class="text-sm text-gray-600">[${timestamp}] ${method} ${url}</div>
                <div class="text-xs text-gray-500 mt-1">请求: ${JSON.stringify(requestData)}</div>
                <div class="text-xs text-gray-500 mt-1">响应: ${JSON.stringify(responseData)}</div>
            `;
            
            // 添加到历史记录的顶部
            try {
                if (historyElement.firstChild) {
                    historyElement.insertBefore(historyItem, historyElement.firstChild);
                } else {
                    historyElement.appendChild(historyItem);
                }
                
                // 限制历史记录数量
                const maxHistoryItems = 10;
                const historyItems = historyElement.querySelectorAll('div');
                if (historyItems.length > maxHistoryItems) {
                    // 检查元素是否仍然存在于DOM中
                    if (document.contains(historyItems[historyItems.length - 1])) {
                        try {
                            historyElement.removeChild(historyItems[historyItems.length - 1]);
                        } catch (error) {
                            // 忽略移除失败的错误
                            console.log('移除历史记录时出错:', error);
                        }
                    }
                }
            } catch (error) {
                // 捕获并记录所有可能的DOM操作错误
                console.log('添加请求历史时出错:', error);
            }
        }

        // 测试连接
        function testConnection() {
            showLoading();
            fetch(apiBaseUrl + '/check/legality', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ akey: 'test', vkey: 'test' })
            })
            .then(response => {
                hideLoading();
                const statusElement = document.getElementById('connection-status');
                if (response.ok) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = '连接成功';
                    showAlert('API连接成功！', 'success');
                } else {
                    statusElement.className = 'badge bg-danger';
                    statusElement.textContent = '连接失败';
                    showAlert('API连接失败，请检查地址是否正确。', 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                const statusElement = document.getElementById('connection-status');
                statusElement.className = 'badge bg-danger';
                statusElement.textContent = '连接失败';
                showAlert('API连接失败: ' + error.message, 'danger');
            });
        }

        // 处理登录
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showAlert('请输入用户名和密码', 'warning');
                return;
            }
            
            showLoading();
            fetch(apiBaseUrl + '/admin/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                addRequestHistory('POST', '/admin/login', { username, password }, data);
                
                if (data.code === 200) {
                    token = data.data.token;
                    const loginInfoElement = document.getElementById('login-info');
                    loginInfoElement.innerHTML = `
                        <p class="mb-1"><strong>登录状态:</strong> <span class="text-success">已登录</span></p>
                        <p class="mb-1"><strong>用户名:</strong> ${username}</p>
                        <p class="mb-1"><strong>Token:</strong> ${token}</p>
                        <p class="mb-1"><strong>过期时间:</strong> ${data.data.expires_at}</p>
                    `;
                    
                    // 启用其他标签页
                    document.querySelector('#software-tab').removeAttribute('disabled');
                    document.querySelector('#version-tab').removeAttribute('disabled');
                    
                    showAlert('登录成功！', 'success');
                } else {
                    showAlert('登录失败: ' + (data.message || '未知错误'), 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('登录失败: ' + error.message, 'danger');
            });
        }

        // 处理修改密码
        function handleChangePassword() {
            if (!token) {
                showAlert('请先登录', 'warning');
                return;
            }
            
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            
            if (!oldPassword || !newPassword) {
                showAlert('请输入原密码和新密码', 'warning');
                return;
            }
            
            showLoading();
            fetch(apiBaseUrl + '/admin/password', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                addRequestHistory('PUT', '/admin/password', { old_password: '******', new_password: '******' }, data);
                
                if (data.code === 200) {
                    showAlert('密码修改成功，请重新登录', 'success');
                    // 清空密码表单
                    document.getElementById('change-password-form').reset();
                    // 可以选择是否自动登出
                } else {
                    showAlert('密码修改失败: ' + (data.message || '未知错误'), 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('密码修改失败: ' + error.message, 'danger');
            });
        }

        // 处理创建软件
        function handleCreateSoftware() {
            if (!token) {
                showAlert('请先登录', 'warning');
                return;
            }
            
            const name = document.getElementById('software-name').value;
            const description = document.getElementById('software-description').value;
            
            if (!name) {
                showAlert('请输入软件名称', 'warning');
                return;
            }
            
            showLoading();
            fetch(apiBaseUrl + '/software', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ name, description })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                addRequestHistory('POST', '/software', { name, description }, data);
                
                if (data.code === 200) {
                    showAlert('软件创建成功！', 'success');
                    // 清空表单
                    document.getElementById('create-software-form').reset();
                    // 自动填充查询框
                    document.getElementById('software-akey').value = data.data.akey;
                    document.getElementById('version-akey').value = data.data.akey;
                    document.getElementById('list-version-akey').value = data.data.akey;
                    // 显示软件信息
                    document.getElementById('software-info').textContent = JSON.stringify(data.data, null, 2);
                    // 保存为选中的软件
                    selectedSoftware = data.data;
                } else {
                    showAlert('软件创建失败: ' + (data.message || '未知错误'), 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('软件创建失败: ' + error.message, 'danger');
            });
        }

        // 获取软件信息
        function getSoftwareInfo() {
            if (!token) {
                showAlert('请先登录', 'warning');
                return;
            }
            
            const akey = document.getElementById('software-akey').value;
            
            if (!akey) {
                showAlert('请输入软件AKey', 'warning');
                return;
            }
            
            showLoading();
            fetch(apiBaseUrl + '/software/' + akey, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                addRequestHistory('GET', '/software/' + akey, {}, data);
                
                if (data.code === 200) {
                    document.getElementById('software-info').textContent = JSON.stringify(data.data, null, 2);
                    // 保存为选中的软件
                    selectedSoftware = data.data;
                    // 填充相关表单
                    document.getElementById('version-akey').value = akey;
                    document.getElementById('list-version-akey').value = akey;
                } else {
                    showAlert('获取软件信息失败: ' + (data.message || '未知错误'), 'danger');
                    document.getElementById('software-info').textContent = '错误: ' + (data.message || '未知错误');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('获取软件信息失败: ' + error.message, 'danger');
                document.getElementById('software-info').textContent = '错误: ' + error.message;
            });
        }

        // 获取软件列表
        function getSoftwareList() {
            if (!token) {
                showAlert('请先登录', 'warning');
                return;
            }
            
            const page = document.getElementById('software-page').value;
            const size = document.getElementById('software-size').value;
            
            showLoading();
            fetch(apiBaseUrl + '/software?page=' + page + '&size=' + size, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                addRequestHistory('GET', '/software?page=' + page + '&size=' + size, {}, data);
                
                if (data.code === 200) {
                    document.getElementById('software-list').textContent = JSON.stringify(data.data, null, 2);
                    // 如果有软件列表，自动填充第一个到查询框
                    if (data.data && data.data.list && data.data.list.length > 0) {
                        const firstSoftware = data.data.list[0];
                        document.getElementById('software-akey').value = firstSoftware.akey;
                        document.getElementById('version-akey').value = firstSoftware.akey;
                        document.getElementById('list-version-akey').value = firstSoftware.akey;
                    }
                } else {
                    showAlert('获取软件列表失败: ' + (data.message || '未知错误'), 'danger');
                    document.getElementById('software-list').textContent = '错误: ' + (data.message || '未知错误');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('获取软件列表失败: ' + error.message, 'danger');
                document.getElementById('software-list').textContent = '错误: ' + error.message;
            });
        }

        // 处理创建版本
        function handleCreateVersion() {
            if (!token) {
                showAlert('请先登录', 'warning');
                return;
            }
            
            const akey = document.getElementById('version-akey').value;
            const version = document.getElementById('version-number').value;
            const description = document.getElementById('version-description').value;
            const isLatest = document.getElementById('version-is-latest').checked;
            
            if (!akey || !version) {
                showAlert('请输入软件AKey和版本号', 'warning');
                return;
            }
            
            showLoading();
            fetch(apiBaseUrl + '/software/' + akey + '/versions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ version, description, is_latest: isLatest })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                addRequestHistory('POST', '/software/' + akey + '/versions', { version, description, is_latest: isLatest }, data);
                
                if (data.code === 200) {
                    showAlert('版本发布成功！', 'success');
                    // 清空表单
                    document.getElementById('version-number').value = '';
                    document.getElementById('version-description').value = '';
                    document.getElementById('version-is-latest').checked = false;
                    // 自动填充查询框
                    document.getElementById('version-vkey').value = data.data.vkey;
                    // 显示版本信息
                    document.getElementById('version-info').textContent = JSON.stringify(data.data, null, 2);
                    // 保存为选中的版本
                    selectedVersion = data.data;
                } else {
                    showAlert('版本发布失败: ' + (data.message || '未知错误'), 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('版本发布失败: ' + error.message, 'danger');
            });
        }

        // 获取版本信息
        function getVersionInfo() {
            if (!token) {
                showAlert('请先登录', 'warning');
                return;
            }
            
            const vkey = document.getElementById('version-vkey').value;
            
            if (!vkey) {
                showAlert('请输入版本VKey', 'warning');
                return;
            }
            
            showLoading();
            fetch(apiBaseUrl + '/versions/' + vkey, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                addRequestHistory('GET', '/versions/' + vkey, {}, data);
                
                if (data.code === 200) {
                    document.getElementById('version-info').textContent = JSON.stringify(data.data, null, 2);
                    // 保存为选中的版本
                    selectedVersion = data.data;
                    // 填充相关表单
                    document.getElementById('version-akey').value = data.data.akey;
                    document.getElementById('list-version-akey').value = data.data.akey;
                } else {
                    showAlert('获取版本信息失败: ' + (data.message || '未知错误'), 'danger');
                    document.getElementById('version-info').textContent = '错误: ' + (data.message || '未知错误');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('获取版本信息失败: ' + error.message, 'danger');
                document.getElementById('version-info').textContent = '错误: ' + error.message;
            });
        }

        // 获取版本列表
        function getVersionList() {
            if (!token) {
                showAlert('请先登录', 'warning');
                return;
            }
            
            const akey = document.getElementById('list-version-akey').value;
            const page = document.getElementById('version-page').value;
            const size = document.getElementById('version-size').value;
            
            if (!akey) {
                showAlert('请输入软件AKey', 'warning');
                return;
            }
            
            showLoading();
            fetch(apiBaseUrl + '/software/' + akey + '/versions?page=' + page + '&size=' + size, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                addRequestHistory('GET', '/software/' + akey + '/versions?page=' + page + '&size=' + size, {}, data);
                
                if (data.code === 200) {
                    document.getElementById('version-list').textContent = JSON.stringify(data.data, null, 2);
                    // 如果有版本列表，自动填充第一个到查询框
                    if (data.data && data.data.list && data.data.list.length > 0) {
                        // 注意：列表中可能不包含vkey，需要进一步查询
                    }
                } else {
                    showAlert('获取版本列表失败: ' + (data.message || '未知错误'), 'danger');
                    document.getElementById('version-list').textContent = '错误: ' + (data.message || '未知错误');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('获取版本列表失败: ' + error.message, 'danger');
                document.getElementById('version-list').textContent = '错误: ' + error.message;
            });
        }

        // 处理校验合法性
        function handleCheckLegality() {
            const akey = document.getElementById('legality-akey').value;
            const vkey = document.getElementById('legality-vkey').value;
            
            if (!akey || !vkey) {
                showAlert('请输入软件AKey和版本VKey', 'warning');
                return;
            }
            
            showLoading();
            fetch(apiBaseUrl + '/check/legality', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ akey, vkey })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                document.getElementById('legality-result').textContent = JSON.stringify(data.data, null, 2);
                
                if (data.code === 200) {
                    if (data.data.legal) {
                        showAlert('AKey和VKey合法！', 'success');
                    } else {
                        showAlert('AKey和VKey不合法: ' + data.data.message, 'danger');
                    }
                } else {
                    showAlert('校验失败: ' + (data.message || '未知错误'), 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('校验失败: ' + error.message, 'danger');
                document.getElementById('legality-result').textContent = '错误: ' + error.message;
            });
        }

        // 处理检测更新
        function handleCheckUpdate() {
            const akey = document.getElementById('update-akey').value;
            const vkey = document.getElementById('update-vkey').value;
            
            if (!akey || !vkey) {
                showAlert('请输入软件AKey和版本VKey', 'warning');
                return;
            }
            
            showLoading();
            fetch(apiBaseUrl + '/check/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ akey, vkey })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                document.getElementById('update-result').textContent = JSON.stringify(data.data, null, 2);
                
                if (data.code === 200) {
                    if (data.data.has_update) {
                        showAlert('发现新版本: ' + data.data.latest_version, 'success');
                    } else {
                        showAlert('当前已是最新版本', 'info');
                    }
                } else {
                    showAlert('检测更新失败: ' + (data.message || '未知错误'), 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('检测更新失败: ' + error.message, 'danger');
                document.getElementById('update-result').textContent = '错误: ' + error.message;
            });
        }
    </script>
</body>
</html>